<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Kazi ni Kazi</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300;14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Additional admin-specific styles */
    .admin-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      margin-top: 24px;
    }
    .admin-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
    }
    .admin-card h2 {
      font-size: 1.4rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .admin-list {
      list-style: none;
      margin-top: 16px;
    }
    .admin-list li {
      padding: 12px 0;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .admin-list li:last-child {
      border-bottom: none;
    }
    .flex {
      display: flex;
    }
    .gap-2 {
      gap: 8px;
    }
  </style>
</head>
<body>
  <header class="sticky-header">
    <div class="logo" onclick="location.href='/'">
      <i class="fas fa-briefcase"></i>
      <span>Kazi</span> ni Kazi
    </div>
    <div class="header-actions">
      <button class="btn-icon" onclick="window.location.href='/'"><i class="fas fa-home"></i></button>
    </div>
  </header>

  <main class="container">
    <h1 class="section-title">Admin Dashboard</h1>
    
    <div class="admin-grid">
      <!-- Categories Management -->
      <div class="admin-card">
        <h2><i class="fas fa-tags" style="color: var(--primary);"></i> Categories</h2>
        <form onsubmit="addCategory(event)">
          <div class="flex" style="gap: 8px;">
            <input type="text" id="categoryName" placeholder="New category" class="form-input" style="flex: 1;" required>
            <button type="submit" class="btn-primary" style="width: auto; padding: 14px 24px;">Add</button>
          </div>
        </form>
        <ul id="categoriesList" class="admin-list"></ul>
      </div>

      <!-- Districts Management -->
      <div class="admin-card">
        <h2><i class="fas fa-map-marker-alt" style="color: var(--primary);"></i> Districts</h2>
        <form onsubmit="addDistrict(event)">
          <div class="flex" style="gap: 8px;">
            <input type="text" id="districtName" placeholder="New district" class="form-input" style="flex: 1;" required>
            <button type="submit" class="btn-primary" style="width: auto; padding: 14px 24px;">Add</button>
          </div>
        </form>
        <ul id="districtsList" class="admin-list"></ul>
      </div>

      <!-- Account Verification -->
      <div class="admin-card">
        <h2><i class="fas fa-check-circle" style="color: var(--primary);"></i> Pending Verification</h2>
        <div id="pendingAccounts"></div>
      </div>

      <!-- All Users -->
      <div class="admin-card">
        <h2><i class="fas fa-users" style="color: var(--primary);"></i> All Users</h2>
        <div id="allUsers"></div>
      </div>
    </div>
  </main>

  <script type="module">
    // Import Firebase config
    import { db, showToast } from './firebase-cfg.js';
    import { 
      collection, getDocs, addDoc, deleteDoc, doc, updateDoc, query, where 
    } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js';

    // ==================== INITIAL LOAD ====================
    // Load all data immediately without auth checks
    loadCategories();
    loadDistricts();
    loadPendingAccounts();
    loadAllUsers();

    // ==================== CATEGORIES MANAGEMENT ====================
    window.addCategory = async (e) => {
      e.preventDefault();
      const name = document.getElementById('categoryName').value.trim();
      if (!name) {
        showToast('Please enter a category name', 'error');
        return;
      }
      
      try {
        await addDoc(collection(db, 'categories'), { 
          name,
          createdAt: new Date().toISOString()
        });
        showToast('Category added successfully', 'success');
        document.getElementById('categoryName').value = '';
        loadCategories();
      } catch (error) {
        showToast('Error adding category: ' + error.message, 'error');
      }
    };

    async function loadCategories() {
      try {
        const snap = await getDocs(collection(db, 'categories'));
        const list = document.getElementById('categoriesList');
        list.innerHTML = '';
        
        if (snap.empty) {
          list.innerHTML = '<li style="justify-content: center; color: var(--gray-500);">No categories yet</li>';
          return;
        }
        
        snap.forEach(doc => {
          list.innerHTML += `
            <li>
              <span><i class="fas fa-tag" style="color: var(--gray-500); margin-right: 8px;"></i>${doc.data().name}</span>
              <button onclick="deleteCategory('${doc.id}')" class="btn-icon" style="width: 36px; height: 36px;">
                <i class="fas fa-trash" style="color: var(--danger);"></i>
              </button>
            </li>
          `;
        });
      } catch (error) {
        showToast('Error loading categories: ' + error.message, 'error');
      }
    }

    window.deleteCategory = async (id) => {
      if (confirm('Are you sure you want to delete this category?')) {
        try {
          await deleteDoc(doc(db, 'categories', id));
          showToast('Category deleted', 'success');
          loadCategories();
        } catch (error) {
          showToast('Error deleting category: ' + error.message, 'error');
        }
      }
    };

    // ==================== DISTRICTS MANAGEMENT ====================
    window.addDistrict = async (e) => {
      e.preventDefault();
      const name = document.getElementById('districtName').value.trim();
      if (!name) {
        showToast('Please enter a district name', 'error');
        return;
      }
      
      try {
        await addDoc(collection(db, 'districts'), { 
          name,
          createdAt: new Date().toISOString()
        });
        showToast('District added successfully', 'success');
        document.getElementById('districtName').value = '';
        loadDistricts();
      } catch (error) {
        showToast('Error adding district: ' + error.message, 'error');
      }
    };

    async function loadDistricts() {
      try {
        const snap = await getDocs(collection(db, 'districts'));
        const list = document.getElementById('districtsList');
        list.innerHTML = '';
        
        if (snap.empty) {
          list.innerHTML = '<li style="justify-content: center; color: var(--gray-500);">No districts yet</li>';
          return;
        }
        
        snap.forEach(doc => {
          list.innerHTML += `
            <li>
              <span><i class="fas fa-map-pin" style="color: var(--gray-500); margin-right: 8px;"></i>${doc.data().name}</span>
              <button onclick="deleteDistrict('${doc.id}')" class="btn-icon" style="width: 36px; height: 36px;">
                <i class="fas fa-trash" style="color: var(--danger);"></i>
              </button>
            </li>
          `;
        });
      } catch (error) {
        showToast('Error loading districts: ' + error.message, 'error');
      }
    }

    window.deleteDistrict = async (id) => {
      if (confirm('Are you sure you want to delete this district?')) {
        try {
          await deleteDoc(doc(db, 'districts', id));
          showToast('District deleted', 'success');
          loadDistricts();
        } catch (error) {
          showToast('Error deleting district: ' + error.message, 'error');
        }
      }
    };

    // ==================== PENDING ACCOUNTS ====================
    async function loadPendingAccounts() {
      try {
        const workers = await getDocs(query(
          collection(db, 'users'), 
          where('role', '==', 'freelancer'), 
          where('verified', '==', false)
        ));
        
        const companies = await getDocs(query(
          collection(db, 'users'), 
          where('role', '==', 'company'), 
          where('verified', '==', false)
        ));
        
        const container = document.getElementById('pendingAccounts');
        container.innerHTML = '';
        
        if (workers.empty && companies.empty) {
          container.innerHTML = '<p class="text-center" style="color: var(--gray-500); padding: 20px;">No pending verifications</p>';
          return;
        }
        
        workers.forEach(doc => {
          container.innerHTML += createAccountCard(doc, 'freelancer');
        });
        
        companies.forEach(doc => {
          container.innerHTML += createAccountCard(doc, 'company');
        });
      } catch (error) {
        showToast('Error loading pending accounts: ' + error.message, 'error');
      }
    }

    function createAccountCard(doc, role) {
      const data = doc.data();
      return `
        <div class="admin-card" style="margin-bottom: 12px; padding: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${data.fullName || data.companyName || 'Unknown'}</strong>
              <p style="font-size: 0.9rem; color: var(--gray-500);">${data.email || 'No email'} • ${role}</p>
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="verifyAccount('${doc.id}')" class="btn-primary" style="padding: 8px 16px; width: auto;">Verify</button>
              <button onclick="deleteAccount('${doc.id}')" class="btn-outline" style="padding: 8px 16px; width: auto;">Remove</button>
            </div>
          </div>
        </div>
      `;
    }

    window.verifyAccount = async (id) => {
      try {
        await updateDoc(doc(db, 'users', id), { verified: true });
        showToast('Account verified successfully', 'success');
        loadPendingAccounts();
        loadAllUsers();
      } catch (error) {
        showToast('Error verifying account: ' + error.message, 'error');
      }
    };

    // ==================== ALL USERS ====================
    async function loadAllUsers() {
      try {
        const snap = await getDocs(collection(db, 'users'));
        const container = document.getElementById('allUsers');
        container.innerHTML = '';
        
        if (snap.empty) {
          container.innerHTML = '<p class="text-center" style="color: var(--gray-500); padding: 20px;">No users found</p>';
          return;
        }
        
        snap.forEach(doc => {
          const data = doc.data();
          container.innerHTML += `
            <div class="admin-card" style="margin-bottom: 12px; padding: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>${data.fullName || data.companyName || data.uniqueName || 'Unknown'}</strong>
                  <p style="font-size: 0.9rem; color: var(--gray-500);">${data.email || 'No email'} • ${data.role || 'unknown'}</p>
                  ${data.district ? `<small style="color: var(--gray-500);">${data.district}</small>` : ''}
                </div>
                <div style="display: flex; gap: 8px;">
                  <button onclick="toggleVerify('${doc.id}', ${!data.verified})" class="btn-icon" style="width: 36px; height: 36px;" title="${data.verified ? 'Unverify' : 'Verify'}">
                    <i class="fas fa-check-circle" style="color: ${data.verified ? 'var(--primary)' : 'var(--gray-400)'};"></i>
                  </button>
                  <button onclick="deleteAccount('${doc.id}')" class="btn-icon" style="width: 36px; height: 36px;" title="Delete">
                    <i class="fas fa-trash" style="color: var(--danger);"></i>
                  </button>
                </div>
              </div>
            </div>
          `;
        });
      } catch (error) {
        showToast('Error loading users: ' + error.message, 'error');
      }
    }

    window.toggleVerify = async (id, verified) => {
      try {
        await updateDoc(doc(db, 'users', id), { verified });
        showToast(`Verification ${verified ? 'added' : 'removed'}`, 'success');
        loadPendingAccounts();
        loadAllUsers();
      } catch (error) {
        showToast('Error updating verification: ' + error.message, 'error');
      }
    };

    window.deleteAccount = async (id) => {
      if (confirm('Are you sure you want to delete this account? This action cannot be undone.')) {
        try {
          await deleteDoc(doc(db, 'users', id));
          showToast('Account removed successfully', 'success');
          loadPendingAccounts();
          loadAllUsers();
        } catch (error) {
          showToast('Error deleting account: ' + error.message, 'error');
        }
      }
    };

    // ==================== HELPER FUNCTIONS ====================
    // Make functions globally available
    window.loadCategories = loadCategories;
    window.loadDistricts = loadDistricts;
    window.loadPendingAccounts = loadPendingAccounts;
    window.loadAllUsers = loadAllUsers;
  </script>
</body>
</html>
