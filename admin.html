<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Kazi ni Kazi</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300;14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="sticky-header">
    <div class="logo" onclick="location.href='/'">
      <i class="fas fa-briefcase"></i>
      <span>Kazi</span> ni Kazi
    </div>
    <div class="header-actions">
      <button class="btn-icon" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
    </div>
  </header>

  <main class="container">
    <h1 class="section-title">Admin Dashboard</h1>
    
    <div class="admin-grid">
      <!-- Categories Management -->
      <div class="admin-card">
        <h2><i class="fas fa-tags" style="color: var(--primary);"></i> Categories</h2>
        <form onsubmit="addCategory(event)">
          <div class="form-group flex" style="gap: 8px;">
            <input type="text" id="categoryName" placeholder="New category" class="form-input" style="flex: 1;" required>
            <button type="submit" class="btn-primary" style="width: auto; padding: 14px 24px;">Add</button>
          </div>
        </form>
        <ul id="categoriesList" class="admin-list"></ul>
      </div>

      <!-- Districts Management -->
      <div class="admin-card">
        <h2><i class="fas fa-map-marker-alt" style="color: var(--primary);"></i> Districts</h2>
        <form onsubmit="addDistrict(event)">
          <div class="form-group flex" style="gap: 8px;">
            <input type="text" id="districtName" placeholder="New district" class="form-input" style="flex: 1;" required>
            <button type="submit" class="btn-primary" style="width: auto; padding: 14px 24px;">Add</button>
          </div>
        </form>
        <ul id="districtsList" class="admin-list"></ul>
      </div>

      <!-- Account Verification -->
      <div class="admin-card">
        <h2><i class="fas fa-check-circle" style="color: var(--primary);"></i> Pending Verification</h2>
        <div id="pendingAccounts"></div>
      </div>

      <!-- All Users -->
      <div class="admin-card">
        <h2><i class="fas fa-users" style="color: var(--primary);"></i> All Users</h2>
        <div id="allUsers"></div>
      </div>
    </div>
  </main>

  <script type="module">
    // Import Firebase config
    import { auth, db, showToast } from './firebase-cfg.js';
    import { signOut } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js';
    import { 
      collection, getDocs, addDoc, deleteDoc, doc, updateDoc, query, where 
    } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js';

    // Check if user is admin (simple check - you can expand this)
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        location.href = '/';
        return;
      }
      
      // For demo purposes, allow any logged in user to access admin
      // In production, check for admin role in Firestore
      loadCategories();
      loadDistricts();
      loadPendingAccounts();
      loadAllUsers();
    });

    // Categories management
    window.addCategory = async (e) => {
      e.preventDefault();
      const name = document.getElementById('categoryName').value;
      if (!name) return;
      
      await addDoc(collection(db, 'categories'), { name });
      showToast('Category added', 'success');
      document.getElementById('categoryName').value = '';
      loadCategories();
    };

    async function loadCategories() {
      const snap = await getDocs(collection(db, 'categories'));
      const list = document.getElementById('categoriesList');
      list.innerHTML = '';
      snap.forEach(doc => {
        list.innerHTML += `
          <li>
            <span><i class="fas fa-tag" style="color: var(--gray-500); margin-right: 8px;"></i>${doc.data().name}</span>
            <button onclick="deleteCategory('${doc.id}')" class="btn-icon" style="width: 36px; height: 36px;">
              <i class="fas fa-trash" style="color: var(--danger);"></i>
            </button>
          </li>
        `;
      });
    }

    window.deleteCategory = async (id) => {
      if (confirm('Are you sure?')) {
        await deleteDoc(doc(db, 'categories', id));
        showToast('Deleted', 'success');
        loadCategories();
      }
    };

    // Districts management
    window.addDistrict = async (e) => {
      e.preventDefault();
      const name = document.getElementById('districtName').value;
      if (!name) return;
      
      await addDoc(collection(db, 'districts'), { name });
      showToast('District added', 'success');
      document.getElementById('districtName').value = '';
      loadDistricts();
    };

    async function loadDistricts() {
      const snap = await getDocs(collection(db, 'districts'));
      const list = document.getElementById('districtsList');
      list.innerHTML = '';
      snap.forEach(doc => {
        list.innerHTML += `
          <li>
            <span><i class="fas fa-map-pin" style="color: var(--gray-500); margin-right: 8px;"></i>${doc.data().name}</span>
            <button onclick="deleteDistrict('${doc.id}')" class="btn-icon" style="width: 36px; height: 36px;">
              <i class="fas fa-trash" style="color: var(--danger);"></i>
            </button>
          </li>
        `;
      });
    }

    window.deleteDistrict = async (id) => {
      if (confirm('Are you sure?')) {
        await deleteDoc(doc(db, 'districts', id));
        showToast('Deleted', 'success');
        loadDistricts();
      }
    };

    // Load pending accounts
    async function loadPendingAccounts() {
      const workers = await getDocs(query(collection(db, 'users'), where('role', '==', 'worker'), where('verified', '==', false)));
      const companies = await getDocs(query(collection(db, 'users'), where('role', '==', 'company'), where('verified', '==', false)));
      
      const container = document.getElementById('pendingAccounts');
      container.innerHTML = '';
      
      if (workers.empty && companies.empty) {
        container.innerHTML = '<p class="text-center" style="color: var(--gray-500);">No pending verifications</p>';
        return;
      }
      
      workers.forEach(doc => {
        container.innerHTML += createAccountCard(doc, 'worker');
      });
      
      companies.forEach(doc => {
        container.innerHTML += createAccountCard(doc, 'company');
      });
    }

    // Load all users
    async function loadAllUsers() {
      const snap = await getDocs(collection(db, 'users'));
      const container = document.getElementById('allUsers');
      container.innerHTML = '';
      
      snap.forEach(doc => {
        const data = doc.data();
        container.innerHTML += `
          <div class="admin-card" style="margin-bottom: 12px; padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${data.fullName || data.companyName || data.uniqueName}</strong>
                <p style="font-size: 0.9rem; color: var(--gray-500);">${data.email} â€¢ ${data.role}</p>
              </div>
              <div style="display: flex; gap: 8px;">
                <button onclick="toggleVerify('${doc.id}', ${!data.verified})" class="btn-icon" style="width: 36px; height: 36px;">
                  <i class="fas fa-check-circle" style="color: ${data.verified ? 'var(--primary)' : 'var(--gray-400)'};"></i>
                </button>
                <button onclick="deleteAccount('${doc.id}')" class="btn-icon" style="width: 36px; height: 36px;">
                  <i class="fas fa-trash" style="color: var(--danger);"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      });
    }

    function createAccountCard(doc, role) {
      const data = doc.data();
      return `
        <div class="admin-card" style="margin-bottom: 12px; padding: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${data.fullName || data.companyName}</strong>
              <p style="font-size: 0.9rem; color: var(--gray-500);">${data.email}</p>
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="verifyAccount('${doc.id}')" class="btn-primary" style="padding: 8px 16px; width: auto;">Verify</button>
              <button onclick="deleteAccount('${doc.id}')" class="btn-outline" style="padding: 8px 16px; width: auto;">Remove</button>
            </div>
          </div>
        </div>
      `;
    }

    window.verifyAccount = async (id) => {
      await updateDoc(doc(db, 'users', id), { verified: true });
      showToast('Account verified', 'success');
      loadPendingAccounts();
      loadAllUsers();
    };

    window.toggleVerify = async (id, verified) => {
      await updateDoc(doc(db, 'users', id), { verified });
      showToast(`Verification ${verified ? 'added' : 'removed'}`, 'success');
      loadAllUsers();
    };

    window.deleteAccount = async (id) => {
      if (confirm('Are you sure you want to delete this account? This action cannot be undone.')) {
        await deleteDoc(doc(db, 'users', id));
        showToast('Account removed', 'success');
        loadPendingAccounts();
        loadAllUsers();
      }
    };

    window.logout = async () => {
      await signOut(auth);
      location.href = '/';
    };
  </script>
</body>
</html>
