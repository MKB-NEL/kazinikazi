<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - Kazi ni Kazi</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300;14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="sticky-header">
    <div class="logo" onclick="location.href='/'">
      <i class="fas fa-briefcase"></i>
      <span>Kazi</span> ni Kazi
    </div>
    <div class="header-actions">
      <button class="btn-icon" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
    </div>
  </header>

  <main class="container" id="profileContent">
    <div class="spinner"></div>
  </main>

  <!-- Floating Call Button -->
  <button class="fab" id="callFab" onclick="callProfile()" style="display: none;">
    <i class="fas fa-phone"></i>
  </button>

  <!-- Review Modal -->
  <div id="reviewModal" class="modal-overlay hidden">
    <div class="modal-card">
      <h2>Leave a Review</h2>
      <div class="star-rating" id="starRating">
        <i class="far fa-star" onclick="setRating(1)"></i>
        <i class="far fa-star" onclick="setRating(2)"></i>
        <i class="far fa-star" onclick="setRating(3)"></i>
        <i class="far fa-star" onclick="setRating(4)"></i>
        <i class="far fa-star" onclick="setRating(5)"></i>
        <i class="far fa-star" onclick="setRating(6)"></i>
      </div>
      <div class="form-group">
        <textarea id="reviewText" placeholder="Write your review..." class="form-input" rows="4"></textarea>
      </div>
      <button onclick="submitReview()" class="btn-primary">Submit Review</button>
    </div>
  </div>

  <script type="module">
    // Import Firebase config
    import { auth, db, showToast } from './firebase-cfg.js';
    import { 
      doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc 
    } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js';

    const profileId = new URLSearchParams(window.location.search).get('id');
    let profileData = null;
    let currentRating = 0;

    // Load profile
    async function loadProfile() {
      if (!profileId) {
        location.href = '/';
        return;
      }
      
      try {
        const profileDoc = await getDoc(doc(db, 'users', profileId));
        if (!profileDoc.exists()) {
          location.href = '/';
          return;
        }
        
        profileData = profileDoc.data();
        const isOwner = auth.currentUser?.uid === profileId;
        
        const container = document.getElementById('profileContent');
        
        if (profileData.role === 'worker') {
          container.innerHTML = `
            <div class="profile-header">
              <img src="${profileData.profilePicture || 'https://images.unsplash.com/photo-1560250097-0b93528c311a?w=200'}" class="profile-avatar">
              <div class="profile-info">
                <h1 class="profile-name">
                  ${profileData.fullName}
                  ${profileData.verified ? '<i class="fas fa-check-circle" style="color: var(--primary); margin-left: 8px;"></i>' : ''}
                </h1>
                <div class="profile-meta">
                  <span><i class="fas fa-map-marker-alt"></i> ${profileData.district || 'Not set'}</span>
                  <span><i class="fas fa-briefcase"></i> ${profileData.jobCategory || 'General'}</span>
                  <span><i class="fas fa-star" style="color: var(--primary);"></i> ${(profileData.avgRating || 0).toFixed(1)} (${profileData.reviewCount || 0})</span>
                  <span><i class="fas fa-users"></i> ${profileData.followerCount || 0} followers</span>
                </div>
                <div class="profile-meta">
                  <span><i class="fas fa-phone"></i> ${profileData.phone || 'Not provided'}</span>
                  <span><i class="fas fa-envelope"></i> ${profileData.email}</span>
                </div>
                <div class="profile-actions">
                  ${!isOwner ? `
                    <button class="btn-primary" onclick="toggleFollow()"><i class="fas fa-user-plus"></i> Follow</button>
                    <button class="btn-outline" onclick="showReviewModal()"><i class="fas fa-star"></i> Review</button>
                  ` : ''}
                </div>
              </div>
            </div>
            
            <h2 class="section-title">Status: <span class="status-badge status-${(profileData.status || 'available').toLowerCase().replace(' ', '-')}">${profileData.status || 'Available'}</span></h2>
            
            <h2 class="section-title">Portfolio</h2>
            <div id="portfolioGrid" class="image-gallery"></div>
            
            <h2 class="section-title">Reviews</h2>
            <div id="reviewsGrid" class="card-grid"></div>
          `;
          
          loadPortfolio();
          loadReviews();
          
        } else if (profileData.role === 'company') {
          container.innerHTML = `
            <div class="profile-header">
              <img src="${profileData.logo || 'https://images.unsplash.com/photo-1556761175-b413da4baf72?w=200'}" class="profile-avatar">
              <div class="profile-info">
                <h1 class="profile-name">
                  ${profileData.companyName}
                  ${profileData.verified ? '<i class="fas fa-check-circle" style="color: var(--primary); margin-left: 8px;"></i>' : ''}
                </h1>
                <div class="profile-meta">
                  <span><i class="fas fa-map-marker-alt"></i> ${profileData.district || 'Not set'}</span>
                  <span><i class="fas fa-star" style="color: var(--primary);"></i> ${(profileData.avgRating || 0).toFixed(1)} (${profileData.reviewCount || 0})</span>
                  <span><i class="fas fa-users"></i> ${profileData.followerCount || 0} followers</span>
                </div>
                <div class="profile-meta">
                  <span><i class="fas fa-phone"></i> ${profileData.phone || 'Not provided'}</span>
                  <span><i class="fas fa-envelope"></i> ${profileData.email}</span>
                </div>
                <div class="profile-actions">
                  ${!isOwner ? `
                    <button class="btn-primary" onclick="toggleFollow()"><i class="fas fa-user-plus"></i> Follow</button>
                    <button class="btn-outline" onclick="showReviewModal()"><i class="fas fa-star"></i> Review</button>
                  ` : ''}
                </div>
              </div>
            </div>
            
            <h2 class="section-title">Open Jobs</h2>
            <div id="jobsGrid" class="card-grid"></div>
            
            <h2 class="section-title">Reviews</h2>
            <div id="reviewsGrid" class="card-grid"></div>
          `;
          
          loadCompanyJobs();
          loadReviews();
        }
        
        // Show call button if phone exists
        if (profileData.phone) {
          document.getElementById('callFab').style.display = 'flex';
        }
        
      } catch (error) {
        showToast('Error loading profile', 'error');
      }
    }

    // Load portfolio images
    async function loadPortfolio() {
      const grid = document.getElementById('portfolioGrid');
      if (!grid) return;
      
      const images = profileData.portfolioImages || [];
      if (images.length === 0) {
        grid.innerHTML = '<p class="text-center" style="grid-column: 1/-1; color: var(--gray-500);">No portfolio images</p>';
        return;
      }
      
      grid.innerHTML = images.map(url => `
        <img src="${url}" style="width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: var(--radius-md);">
      `).join('');
    }

    // Load company jobs
    async function loadCompanyJobs() {
      const q = query(collection(db, 'jobs'), where('companyId', '==', profileId));
      const snap = await getDocs(q);
      const grid = document.getElementById('jobsGrid');
      
      if (snap.empty) {
        grid.innerHTML = '<p class="text-center" style="grid-column: 1/-1; color: var(--gray-500);">No open jobs</p>';
        return;
      }
      
      grid.innerHTML = '';
      snap.forEach(doc => {
        const job = doc.data();
        grid.innerHTML += `
          <div class="card">
            <div class="card-content">
              <h3 class="card-title">${job.title}</h3>
              <p class="card-subtitle">${job.description}</p>
              <div class="card-footer">
                <span>${job.district || ''}</span>
                <span><strong>${job.budget ? 'RWF ' + Number(job.budget).toLocaleString() : ''}</strong></span>
              </div>
            </div>
          </div>
        `;
      });
    }

    // Load reviews
    async function loadReviews() {
      const q = query(collection(db, 'reviews'), where('targetId', '==', profileId));
      const snap = await getDocs(q);
      const grid = document.getElementById('reviewsGrid');
      
      if (snap.empty) {
        grid.innerHTML = '<p class="text-center" style="grid-column: 1/-1; color: var(--gray-500);">No reviews yet</p>';
        return;
      }
      
      grid.innerHTML = '';
      snap.forEach(doc => {
        const r = doc.data();
        grid.innerHTML += `
          <div class="card">
            <div class="card-content">
              <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
                <img src="${r.reviewerPhoto || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=50'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                <div>
                  <strong>${r.reviewerName}</strong>
                  <div style="color: var(--primary);">
                    ${'★'.repeat(r.rating)}${'☆'.repeat(6 - r.rating)}
                  </div>
                </div>
              </div>
              <p>${r.comment}</p>
            </div>
          </div>
        `;
      });
    }

    // Follow/unfollow
    window.toggleFollow = async () => {
      if (!auth.currentUser) {
        showToast('Please login first', 'error');
        return;
      }
      
      try {
        const followRef = collection(db, 'followers');
        const q = query(followRef, 
          where('followerId', '==', auth.currentUser.uid),
          where('followingId', '==', profileId)
        );
        
        const existing = await getDocs(q);
        
        if (existing.empty) {
          await addDoc(followRef, {
            followerId: auth.currentUser.uid,
            followingId: profileId,
            createdAt: new Date().toISOString()
          });
          
          // Update follower count
          const userRef = doc(db, 'users', profileId);
          await updateDoc(userRef, {
            followerCount: (profileData.followerCount || 0) + 1
          });
          
          showToast('Followed!', 'success');
        } else {
          showToast('Already following', 'info');
        }
      } catch (error) {
        showToast('Error following user', 'error');
      }
    };

    // Review functions
    window.showReviewModal = () => {
      if (!auth.currentUser) {
        showToast('Please login to review', 'error');
        return;
      }
      currentRating = 0;
      document.querySelectorAll('#starRating i').forEach(i => i.className = 'far fa-star');
      document.getElementById('reviewModal').classList.remove('hidden');
    };

    window.setRating = (rating) => {
      currentRating = rating;
      const stars = document.querySelectorAll('#starRating i');
      stars.forEach((star, index) => {
        if (index < rating) {
          star.className = 'fas fa-star';
        } else {
          star.className = 'far fa-star';
        }
      });
    };

    window.submitReview = async () => {
      if (!currentRating) {
        showToast('Please select a rating', 'error');
        return;
      }
      
      const comment = document.getElementById('reviewText').value;
      
      try {
        // Get reviewer info
        const reviewerDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
        const reviewer = reviewerDoc.data();
        
        const reviewData = {
          targetId: profileId,
          reviewerId: auth.currentUser.uid,
          reviewerName: reviewer.fullName || reviewer.companyName || reviewer.uniqueName,
          reviewerPhoto: reviewer.profilePicture || reviewer.logo,
          rating: currentRating,
          comment,
          createdAt: new Date().toISOString()
        };
        
        await addDoc(collection(db, 'reviews'), reviewData);
        
        // Update average rating
        const reviewsSnap = await getDocs(query(collection(db, 'reviews'), where('targetId', '==', profileId)));
        let total = 0;
        reviewsSnap.forEach(r => total += r.data().rating);
        const avg = total / reviewsSnap.size;
        
        await updateDoc(doc(db, 'users', profileId), {
          avgRating: avg,
          reviewCount: reviewsSnap.size
        });
        
        showToast('Review submitted!', 'success');
        document.getElementById('reviewModal').classList.add('hidden');
        loadReviews();
      } catch (error) {
        showToast('Error submitting review', 'error');
      }
    };

    window.callProfile = () => {
      if (profileData?.phone) {
        window.location.href = `tel:${profileData.phone}`;
      }
    };

    window.goBack = () => {
      history.back();
    };

    // Initialize
    loadProfile();
  </script>
</body>
</html>
