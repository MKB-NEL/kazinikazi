<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Kazi ni Kazi Â· Rwanda's Freelance Marketplace</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300;14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* === STYLES (unchanged from previous version) === */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    :root {
      --primary: #ff385c;
      --primary-dark: #e31c5f;
      --gray-50: #f8f9fa;
      --gray-100: #f1f3f5;
      --gray-200: #e9ecef;
      --gray-300: #dee2e6;
      --gray-400: #ced4da;
      --gray-500: #868e96;
      --gray-600: #495057;
      --gray-700: #343a40;
      --gray-800: #212529;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 999px;
      --transition: all 0.2s ease;
    }

    body {
      background: white;
      color: var(--gray-800);
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    * { font-size: clamp(0.875rem, 4vw, 1rem); }
    h1 { font-size: clamp(2rem, 8vw, 2.5rem); }
    h2 { font-size: clamp(1.5rem, 6vw, 1.8rem); }
    h3 { font-size: clamp(1.2rem, 5vw, 1.4rem); }
    .section-title { font-size: clamp(1.5rem, 6vw, 1.8rem); }
    .card-title { font-size: clamp(1rem, 4vw, 1.1rem); }
    .card-subtitle { font-size: clamp(0.8rem, 3.5vw, 0.9rem); }
    .status-badge { font-size: clamp(0.7rem, 3vw, 0.8rem); }

    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 clamp(16px, 5vw, 32px);
      width: 100%;
      flex: 1;
    }

    .sticky-header {
      position: sticky;
      top: 0;
      background: white;
      border-bottom: 1px solid var(--gray-200);
      padding: clamp(8px, 2vw, 12px) clamp(16px, 4vw, 32px);
      display: flex;
      align-items: center;
      gap: clamp(12px, 3vw, 24px);
      z-index: 100;
      flex-wrap: wrap;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 700;
      font-size: clamp(1.2rem, 5vw, 1.5rem);
      cursor: pointer;
      white-space: nowrap;
    }
    .logo i { font-size: 1.2em; color: var(--primary); }
    .logo span { color: var(--primary); }

    .main-nav {
      display: flex;
      gap: clamp(6px, 2vw, 20px);
      align-items: center;
      flex: 1 1 auto;
      justify-content: center;
    }
    .nav-item {
      font-weight: 600;
      font-size: clamp(0.9rem, 3.5vw, 1rem);
      color: var(--gray-600);
      cursor: pointer;
      padding: clamp(4px, 1.2vw, 8px) clamp(10px, 2vw, 16px);
      border-radius: var(--radius-full);
      transition: var(--transition);
      white-space: nowrap;
    }
    .nav-item:hover { color: var(--primary); background: var(--gray-100); }
    .nav-item.active { color: var(--primary); background: rgba(255, 56, 92, 0.1); }

    .search-container {
      position: relative;
      max-width: 300px;
      width: 100%;
    }
    .search-input-wrapper {
      display: flex;
      align-items: center;
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-full);
      padding: 2px 2px 2px 16px;
      transition: var(--transition);
    }
    .search-input-wrapper:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 56, 92, 0.1);
      background: white;
    }
    .search-input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      padding: 8px 0;
      min-width: 120px;
      font-size: 0.95rem;
    }
    .search-btn-small {
      background: var(--primary);
      border: none;
      border-radius: var(--radius-full);
      width: 36px;
      height: 36px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    .search-btn-small:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    .live-search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      margin-top: 8px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      border: 1px solid var(--gray-200);
    }
    .search-result-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--gray-200);
      cursor: pointer;
      transition: var(--transition);
    }
    .search-result-item:hover {
      background: var(--gray-100);
    }
    .result-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .result-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: var(--primary);
    }
    .result-info {
      flex: 1;
    }
    .result-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 2px;
    }
    .result-subtitle {
      font-size: 0.8rem;
      color: var(--gray-500);
    }
    .result-badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      background: var(--gray-100);
      color: var(--gray-600);
    }

    .header-actions {
      display: flex;
      align-items: center;
    }
    .btn-icon {
      background: var(--gray-100);
      border: none;
      border-radius: var(--radius-full);
      width: 44px;
      height: 44px;
      font-size: 1.2rem;
      color: var(--gray-700);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    .btn-icon:hover {
      background: var(--gray-200);
      transform: scale(1.05);
    }

    .hero {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: clamp(24px, 6vw, 48px) 0 16px;
    }
    .hero h1 { font-weight: 700; letter-spacing: -0.02em; }
    .hero h1 span { color: var(--primary); }
    .hero p { color: var(--gray-500); font-size: 1.2rem; }

    .location-banner {
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: clamp(12px, 3vw, 18px) clamp(16px, 4vw, 24px);
      margin: 16px 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    .location-text {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .location-text i { font-size: 1.8rem; color: var(--primary); }
    .location-text div strong { font-size: 1rem; }
    .location-text div p { font-size: 0.85rem; color: var(--gray-600); }
    .location-btn-small {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius-full);
      padding: 8px 20px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: var(--transition);
    }
    .location-btn-small:hover {
      background: var(--primary-dark);
      transform: scale(1.02);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 32px 0 16px;
    }
    .section-header h2 { 
      display: flex; 
      align-items: center; 
      gap: 8px;
      font-size: 1.6rem;
    }
    .section-header h2 i { 
      color: var(--primary);
      font-size: 1.8rem;
    }
    .section-link {
      color: var(--primary);
      font-weight: 500;
      cursor: pointer;
      font-size: 0.95rem;
      transition: var(--transition);
    }
    .section-link:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    .category-chips {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 16px 0 20px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .category-chips::-webkit-scrollbar {
      display: none;
    }
    .category-chip {
      padding: 8px 20px;
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-full);
      white-space: nowrap;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }
    .category-chip:hover {
      background: var(--gray-200);
    }
    .category-chip.active { 
      background: var(--primary); 
      color: white; 
      border-color: var(--primary);
    }

    .card-grid {
      display: flex;
      flex-wrap: wrap;
      gap: clamp(16px, 3vw, 24px);
      margin-bottom: 32px;
    }
    .card {
      flex: 1 1 calc(25% - 24px);
      min-width: 200px;
      max-width: 100%;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      overflow: hidden;
      transition: var(--transition);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
    }
    .card:hover { 
      transform: translateY(-4px); 
      box-shadow: var(--shadow-md);
    }
    .card-image {
      position: relative;
      aspect-ratio: 1 / 1;
      background: var(--gray-100);
    }
    .card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .card-badge { 
      position: absolute; 
      top: 12px; 
      right: 12px; 
      background: white;
      padding: 4px 8px;
      border-radius: var(--radius-full);
      box-shadow: var(--shadow-sm);
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .card-verified { color: #3b82f6; }
    .card-content { padding: 16px; }
    .card-title { 
      font-weight: 600; 
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
    }
    .card-subtitle { 
      color: var(--gray-500); 
      margin-bottom: 8px;
    }
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
    }
    .card-rating { 
      display: flex; 
      align-items: center; 
      gap: 4px; 
    }
    .card-rating i { color: #fbbf24; }

    .status-badge {
      padding: 4px 12px;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-available { background: #e6f7e6; color: #2e7d32; }
    .status-working { background: #fff4e5; color: #ef6c00; }
    .status-unavailable { background: #ffe5e5; color: #c62828; }

    .auth-dropdown { position: relative; }
    .auth-menu, .login-form {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      min-width: 280px;
      margin-top: 12px;
      padding: 16px;
      z-index: 1000;
      display: none;
      border: 1px solid var(--gray-200);
    }
    .auth-menu.show, .login-form.show { display: block; }
    .auth-option {
      padding: 16px;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      cursor: pointer;
      transition: var(--transition);
    }
    .auth-option:hover { border-color: var(--primary); }
    .auth-option h4 { margin-bottom: 4px; }
    .auth-option p { font-size: 0.85rem; color: var(--gray-500); }

    .login-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .login-tab {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-md);
      background: white;
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }
    .login-tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-full);
      padding: 8px 20px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }
    .btn-outline:hover {
      background: var(--gray-100);
    }

    .modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 16px;
    }
    .modal-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }
    .modal-header { margin-bottom: 20px; }
    .modal-header h2 { margin-bottom: 4px; }
    .modal-header p { color: var(--gray-500); }

    .hidden { display: none !important; }

    .account-grid {
      display: grid;
      gap: 16px;
      margin-bottom: 24px;
    }
    .account-card {
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }
    .account-card:hover { border-color: var(--primary); }
    .account-card.selected {
      border-color: var(--primary);
      background: rgba(255, 56, 92, 0.02);
      position: relative;
    }
    .account-card.selected::after {
      content: 'âœ“';
      position: absolute;
      top: 12px;
      right: 12px;
      color: var(--primary);
      font-weight: 700;
    }
    .account-icon {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 12px;
    }

    .image-upload-area {
      border: 2px dashed var(--gray-300);
      border-radius: var(--radius-md);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }
    .image-upload-area:hover {
      border-color: var(--primary);
      background: var(--gray-50);
    }
    .image-preview { 
      width: 80px; 
      height: 80px; 
      object-fit: cover; 
      border-radius: 50%; 
      display: none; 
      margin: 0 auto 12px;
    }
    .image-preview.show { display: block; }

    .form-group { margin-bottom: 16px; }
    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
    }
    .form-input, .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-md);
      font-size: 1rem;
      transition: var(--transition);
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 56, 92, 0.1);
    }
    .form-help {
      font-size: 0.8rem;
      color: var(--gray-500);
      margin-top: 4px;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius-full);
      padding: 14px 24px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: var(--transition);
    }
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: scale(1.02);
    }
    .text-center { text-align: center; }
    .mt-4 { margin-top: 16px; }

    .spinner { 
      border: 4px solid var(--gray-200); 
      border-top-color: var(--primary); 
      border-radius: 50%; 
      width: 48px; 
      height: 48px; 
      animation: spin 1s linear infinite; 
      margin: 32px auto; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .card { flex: 1 1 calc(50% - 16px); }
      .main-nav { display: none; }
      .section-header h2 { font-size: 1.4rem; }
      .section-header h2 i { font-size: 1.6rem; }
    }
    @media (max-width: 480px) {
      .card { flex: 1 1 100%; }
      .sticky-header { flex-wrap: wrap; }
      .search-container { max-width: 100%; order: 3; }
      .hero h1 { font-size: 2rem; }
      .hero p { font-size: 1rem; }
    }
  </style>
</head>
<body>
  <!-- Header (unchanged) -->
  <header class="sticky-header">
    <div class="logo" onclick="location.href='/'">
      <i class="fas fa-briefcase"></i>
      <span>Kazi</span> ni Kazi
    </div>

    <nav class="main-nav">
      <div class="nav-item active" onclick="KaziModules.UI.switchTab('freelancers')">Freelancers</div>
      <div class="nav-item" onclick="KaziModules.UI.switchTab('jobs')">Jobs</div>
      <div class="nav-item" onclick="KaziModules.UI.switchTab('companies')">Companies</div>
    </nav>

    <div class="search-container">
      <div class="search-input-wrapper">
        <input type="text" class="search-input" id="searchInput" placeholder="Search freelancers, jobs..." autocomplete="off">
        <button class="search-btn-small" onclick="KaziModules.Search.performSearch()">
          <i class="fas fa-search"></i>
        </button>
      </div>
      <div class="live-search-results" id="liveSearchResults"></div>
    </div>

    <div class="header-actions">
      <div class="auth-dropdown">
        <button class="btn-icon" id="authBtn" onclick="KaziModules.Auth.toggleAuthMenu()">
          <i class="fas fa-user"></i>
        </button>
        
        <div class="auth-menu" id="authMenu">
          <div class="auth-option" onclick="KaziModules.Auth.showAccountType('freelancer')">
            <h4><i class="fas fa-hard-hat" style="color: var(--primary);"></i> I'm a Freelancer</h4>
            <p>Find jobs and get hired</p>
          </div>
          <div class="auth-option" onclick="KaziModules.Auth.showAccountType('company')">
            <h4><i class="fas fa-building" style="color: var(--primary);"></i> I'm a Company</h4>
            <p>Post jobs and hire freelancers</p>
          </div>
          <div class="auth-option" onclick="KaziModules.Auth.showAccountType('user')">
            <h4><i class="fas fa-user" style="color: var(--primary);"></i> I'm a User</h4>
            <p>Browse and hire for personal projects</p>
          </div>
          <div style="text-align: center; margin-top: 12px;">
            <button class="btn-outline" style="width: auto; padding: 8px 20px;" onclick="KaziModules.Auth.showLoginForm()">Login</button>
          </div>
        </div>

        <div class="login-form" id="loginForm">
          <div class="login-tabs">
            <button class="login-tab active" onclick="KaziModules.Auth.setLoginRole('freelancer')">Freelancer</button>
            <button class="login-tab" onclick="KaziModules.Auth.setLoginRole('company')">Company</button>
          </div>
          <form onsubmit="KaziModules.Auth.handleLogin(event)">
            <div class="form-group">
              <input type="email" id="loginEmail" placeholder="Email" class="form-input" required>
            </div>
            <div class="form-group">
              <input type="password" id="loginPassword" placeholder="Password" class="form-input" required>
            </div>
            <button type="submit" class="btn-primary">Login</button>
          </form>
          <p class="text-center mt-4">
            <a href="#" onclick="KaziModules.Auth.showSignupForm()">Create an account</a>
          </p>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1>Find work. Hire talent.<br><span>In Rwanda.</span></h1>
      <p>Connect with verified freelancers and companies in your area</p>
    </section>

    <div class="location-banner" id="locationBanner">
      <div class="location-text">
        <i class="fas fa-map-marker-alt"></i>
        <div>
          <strong>Find freelancers near you</strong>
          <p>Allow location access to see nearby freelancers and jobs</p>
        </div>
      </div>
      <button class="location-btn-small" onclick="KaziModules.Location.requestLocation()">Enable Location</button>
    </div>

    <div id="freelancersSection">
      <div class="section-header">
        <h2><i class="fas fa-fire"></i> Most Used Freelancers</h2>
        <span class="section-link" onclick="KaziModules.UI.loadMore('most')">View all â†’</span>
      </div>
      <div id="mostUsedGrid" class="card-grid"></div>

      <div class="section-header">
        <h2><i class="fas fa-clock"></i> Recently Active</h2>
        <span class="section-link" onclick="KaziModules.UI.loadMore('recent')">View all â†’</span>
      </div>
      <div id="recentGrid" class="card-grid"></div>

      <div class="section-header">
        <h2><i class="fas fa-magic"></i> Suggested For You</h2>
        <span class="section-link" onclick="KaziModules.UI.loadMore('suggested')">View all â†’</span>
      </div>
      <div id="suggestedGrid" class="card-grid"></div>

      <div class="category-chips" id="categoryChips"></div>
      <div id="categoryResults" class="card-grid"></div>
    </div>

    <div id="jobsSection" style="display: none;">
      <div class="section-header">
        <h2><i class="fas fa-briefcase"></i> Available Jobs</h2>
      </div>
      <div id="jobsGrid" class="card-grid"></div>
    </div>

    <div id="companiesSection" style="display: none;">
      <div class="section-header">
        <h2><i class="fas fa-building"></i> Trusted Companies</h2>
      </div>
      <div id="companiesGrid" class="card-grid"></div>
    </div>

    <div id="loadingSpinner" class="spinner hidden"></div>
  </main>

  <!-- Auth Modal -->
  <div id="authModal" class="modal-overlay hidden">
    <div class="modal-card">
      <div class="modal-header">
        <h2>Join Kazi ni Kazi</h2>
        <p>Select your account type</p>
      </div>
      <div class="modal-body">
        <div class="account-grid">
          <div class="account-card" onclick="KaziModules.Auth.selectRole('freelancer')" id="role-freelancer">
            <i class="fas fa-hard-hat account-icon"></i>
            <h3>Freelancer</h3>
            <p>Find jobs, showcase skills, get hired</p>
          </div>
          <div class="account-card" onclick="KaziModules.Auth.selectRole('company')" id="role-company">
            <i class="fas fa-building account-icon"></i>
            <h3>Company</h3>
            <p>Post jobs, hire freelancers, build your team</p>
          </div>
          <div class="account-card" onclick="KaziModules.Auth.selectRole('user')" id="role-user">
            <i class="fas fa-user account-icon"></i>
            <h3>User</h3>
            <p>Browse and hire for personal projects</p>
          </div>
        </div>

        <form id="authForm" onsubmit="KaziModules.Auth.handleAuth(event)" class="hidden">
          <h3 id="authFormTitle">Create Freelancer Account</h3>
          <div class="form-group">
            <input type="text" id="fullName" placeholder="Full name" class="form-input" required>
          </div>
          <div class="form-group" id="uniqueNameGroup">
            <input type="text" id="uniqueName" placeholder="Unique username" class="form-input">
            <small class="form-help">One per device, cannot change</small>
          </div>
          <div class="form-group">
            <input type="email" id="email" placeholder="Email" class="form-input" required>
          </div>
          <div class="form-group">
            <input type="password" id="password" placeholder="Password (min 6 chars)" class="form-input" required>
          </div>
          <button type="submit" class="btn-primary" id="authSubmit">Create Account</button>
          <p class="text-center mt-4">
            <a href="#" onclick="KaziModules.Auth.toggleAuthMode()">Already have an account? Sign in</a>
          </p>
        </form>
      </div>
    </div>
  </div>

  <!-- Freelancer Signup Modal -->
  <div id="freelancerSignupModal" class="modal-overlay hidden">
    <div class="modal-card">
      <h2>Freelancer Registration</h2>
      <form onsubmit="KaziModules.Registration.registerFreelancer(event)">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" id="freelancerName" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Profile Picture</label>
          <div class="image-upload-area" onclick="document.getElementById('freelancerImage').click()">
            <img id="freelancerImagePreview" class="image-preview">
            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary);"></i>
            <p>Click to upload</p>
          </div>
          <input type="file" id="freelancerImage" accept="image/*" style="display: none;" onchange="KaziModules.Utils.previewImage(this, 'freelancerImagePreview')">
        </div>
        <div class="form-group">
          <label class="form-label">Phone</label>
          <input type="tel" id="freelancerPhone" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" id="freelancerEmail" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" id="freelancerPassword" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">District</label>
          <select id="freelancerDistrict" class="form-select" required></select>
        </div>
        <div class="form-group">
          <label class="form-label">Job Category</label>
          <select id="freelancerCategory" class="form-select" required></select>
        </div>
        <button type="submit" class="btn-primary">Register</button>
      </form>
    </div>
  </div>

  <!-- Company Signup Modal -->
  <div id="companySignupModal" class="modal-overlay hidden">
    <div class="modal-card">
      <h2>Company Registration</h2>
      <form onsubmit="KaziModules.Registration.registerCompany(event)">
        <div class="form-group">
          <label class="form-label">Company Name</label>
          <input type="text" id="companyName" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Company Logo</label>
          <div class="image-upload-area" onclick="document.getElementById('companyLogo').click()">
            <img id="logoPreview" class="image-preview">
            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary);"></i>
            <p>Click to upload</p>
          </div>
          <input type="file" id="companyLogo" accept="image/*" style="display: none;" onchange="KaziModules.Utils.previewImage(this, 'logoPreview')">
        </div>
        <div class="form-group">
          <label class="form-label">Phone</label>
          <input type="tel" id="companyPhone" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" id="companyEmail" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" id="companyPassword" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">District</label>
          <select id="companyDistrict" class="form-select" required></select>
        </div>
        <button type="submit" class="btn-primary">Register</button>
      </form>
    </div>
  </div>

  <!-- User Signup Modal -->
  <div id="userSignupModal" class="modal-overlay hidden">
    <div class="modal-card">
      <h2>User Registration</h2>
      <form onsubmit="KaziModules.Registration.registerUser(event)">
        <div class="form-group">
          <label class="form-label">Unique Username</label>
          <input type="text" id="userName" class="form-input" required>
          <small class="form-help">Must be unique, one account per device</small>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" id="userEmail" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" id="userPassword" class="form-input" required>
        </div>
        <button type="submit" class="btn-primary">Register</button>
      </form>
    </div>
  </div>

  <script type="module">
    // ==================== GLOBAL NAMESPACE ====================
    window.KaziModules = {};

    // ==================== MODULE: FIREBASE INIT ====================
    (function() {
      console.log('ðŸ”¥ Initializing Firebase...');
      
      import('./firebase-cfg.js').then(module => {
        window.KaziModules.firebase = module;
        window.KaziModules.auth = module.auth;
        window.KaziModules.db = module.db;
        window.KaziModules.IMGBB_API_KEY = module.IMGBB_API_KEY;
        window.KaziModules.IMGBB_URL = module.IMGBB_URL;
        window.KaziModules.deviceId = module.deviceId;
        window.KaziModules.sessionId = module.sessionId;
        window.KaziModules.showToast = module.showToast;
        
        // Initialize app after Firebase is ready
        KaziModules.App.init();
      }).catch(error => {
        console.error('Firebase initialization failed:', error);
      });
    })();

    // ==================== MODULE: UTILITIES ====================
    KaziModules.Utils = {
      previewImage: (input, previewId) => {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const preview = document.getElementById(previewId);
            preview.src = e.target.result;
            preview.classList.add('show');
          };
          reader.readAsDataURL(input.files[0]);
        }
      },

      showSpinner: (show) => {
        const spinner = document.getElementById('loadingSpinner');
        if (show) {
          spinner.classList.remove('hidden');
        } else {
          spinner.classList.add('hidden');
        }
      },

      closeModals: () => {
        document.querySelectorAll('.modal-overlay').forEach(modal => {
          modal.classList.add('hidden');
        });
      },

      formatCurrency: (amount) => {
        return 'RWF ' + Number(amount || 0).toLocaleString();
      },

      getTimeAgo: (timestamp) => {
        const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
        if (seconds < 60) return 'just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
        if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
        return Math.floor(seconds / 86400) + ' days ago';
      }
    };

    // ==================== MODULE: LOCATION ====================
    KaziModules.Location = {
      userLocation: null,

      requestLocation: function() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              this.userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
              localStorage.setItem('userLocation', JSON.stringify(this.userLocation));
              document.getElementById('locationBanner').style.display = 'none';
              KaziModules.showToast('Location enabled! Showing nearby freelancers', 'success');
              KaziModules.Data.loadAllData();
            },
            (error) => {
              KaziModules.showToast('Please enable location for better results', 'info');
            }
          );
        }
      },

      getDistance: (lat1, lon1, lat2, lon2) => {
        if (!lat1 || !lon1 || !lat2 || !lon2) return null;
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      },

      init: function() {
        const savedLocation = localStorage.getItem('userLocation');
        if (savedLocation) {
          this.userLocation = JSON.parse(savedLocation);
          document.getElementById('locationBanner').style.display = 'none';
        }
      }
    };

    // ==================== MODULE: DATA ====================
    KaziModules.Data = {
      allFreelancers: [],
      allCompanies: [],
      allJobs: [],
      allCategories: [],
      allDistricts: [],

      async loadAllData() {
        KaziModules.Utils.showSpinner(true);
        
        try {
          const { db } = KaziModules;
          
          // Load freelancers
          const freelancersSnap = await KaziModules.firebase.getDocs(
            KaziModules.firebase.query(
              KaziModules.firebase.collection(db, 'users'), 
              KaziModules.firebase.where('role', '==', 'freelancer')
            )
          );
          this.allFreelancers = freelancersSnap.docs.map(d => ({ uid: d.id, ...d.data() }));
          
          // Load companies
          const companiesSnap = await KaziModules.firebase.getDocs(
            KaziModules.firebase.query(
              KaziModules.firebase.collection(db, 'users'), 
              KaziModules.firebase.where('role', '==', 'company')
            )
          );
          this.allCompanies = companiesSnap.docs.map(d => ({ uid: d.id, ...d.data() }));
          
          // Load jobs
          const jobsSnap = await KaziModules.firebase.getDocs(
            KaziModules.firebase.collection(db, 'jobs')
          );
          this.allJobs = jobsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
          
          // Load categories
          const categoriesSnap = await KaziModules.firebase.getDocs(
            KaziModules.firebase.collection(db, 'categories')
          );
          this.allCategories = categoriesSnap.docs.map(d => d.data().name);
          
          // Load districts
          const districtsSnap = await KaziModules.firebase.getDocs(
            KaziModules.firebase.collection(db, 'districts')
          );
          this.allDistricts = districtsSnap.docs.map(d => d.data().name);
          
          // Populate dropdowns
          KaziModules.UI.populateDropdowns();
          
          // Render sections
          KaziModules.Render.renderCurrentTab();
          KaziModules.Render.renderCategoryChips();
          
        } catch (error) {
          console.error('Error loading data:', error);
          KaziModules.showToast('Error loading data', 'error');
        } finally {
          KaziModules.Utils.showSpinner(false);
        }
      },

      getMostUsed: function() {
        return [...this.allFreelancers]
          .sort((a, b) => (b.views || 0) - (a.views || 0))
          .slice(0, 8);
      },

      getRecent: function() {
        return [...this.allFreelancers]
          .sort((a, b) => {
            if (a.status === 'Available' && b.status !== 'Available') return -1;
            if (a.status !== 'Available' && b.status === 'Available') return 1;
            return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
          })
          .slice(0, 8);
      },

      getSuggested: function() {
        return [...this.allFreelancers]
          .sort((a, b) => (b.avgRating || 0) - (a.avgRating || 0))
          .slice(0, 8);
      },

      getCategoryFreelancers: function(category) {
        return this.allFreelancers.filter(f => f.jobCategory === category).slice(0, 8);
      },

      search: function(query) {
        query = query.toLowerCase();
        const results = [];
        
        this.allFreelancers.forEach(f => {
          if (f.fullName?.toLowerCase().includes(query) || 
              f.jobCategory?.toLowerCase().includes(query) ||
              f.district?.toLowerCase().includes(query)) {
            results.push({ type: 'freelancer', data: f, id: f.uid });
          }
        });
        
        this.allCompanies.forEach(c => {
          if (c.companyName?.toLowerCase().includes(query) ||
              c.district?.toLowerCase().includes(query)) {
            results.push({ type: 'company', data: c, id: c.uid });
          }
        });
        
        this.allJobs.forEach(j => {
          if (j.title?.toLowerCase().includes(query) ||
              j.description?.toLowerCase().includes(query)) {
            results.push({ type: 'job', data: j, id: j.id });
          }
        });
        
        return results.slice(0, 10);
      }
    };

    // ==================== MODULE: RENDER ====================
    KaziModules.Render = {
      createFreelancerCard: (freelancer) => {
        return `
          <div class="card" onclick="location.href='profile.html?id=${freelancer.uid}'">
            <div class="card-image">
              <img src="${freelancer.profilePicture || 'https://images.unsplash.com/photo-1560250097-0b93528c311a?w=400'}" loading="lazy">
              ${freelancer.verified ? '<span class="card-badge"><i class="fas fa-check-circle card-verified"></i> Verified</span>' : ''}
            </div>
            <div class="card-content">
              <div class="card-title">${freelancer.fullName || 'Freelancer'}</div>
              <div class="card-subtitle">${freelancer.jobCategory || 'General'} â€¢ ${freelancer.district || ''}</div>
              <div class="card-footer">
                <span class="card-rating">
                  <i class="fas fa-star"></i> ${(freelancer.avgRating || 0).toFixed(1)}
                </span>
                <span class="status-badge status-${(freelancer.status || 'available').toLowerCase().replace(' ', '-')}">
                  ${freelancer.status || 'Available'}
                </span>
              </div>
            </div>
          </div>
        `;
      },

      createCompanyCard: (company) => {
        return `
          <div class="card" onclick="location.href='profile.html?id=${company.uid}'">
            <div class="card-image">
              <img src="${company.logo || 'https://images.unsplash.com/photo-1556761175-b413da4baf72?w=400'}" loading="lazy">
              ${company.verified ? '<span class="card-badge"><i class="fas fa-check-circle card-verified"></i> Verified</span>' : ''}
            </div>
            <div class="card-content">
              <div class="card-title">${company.companyName || 'Company'}</div>
              <div class="card-subtitle">${company.district || ''}</div>
              <div class="card-footer">
                <span class="card-rating">
                  <i class="fas fa-star"></i> ${(company.avgRating || 0).toFixed(1)}
                </span>
                <span>${KaziModules.Data.allJobs.filter(j => j.companyId === company.uid).length} jobs</span>
              </div>
            </div>
          </div>
        `;
      },

      createJobCard: (job) => {
        return `
          <div class="card" onclick="location.href='job.html?id=${job.id}'">
            <div class="card-image">
              <img src="https://images.unsplash.com/photo-1486312338219-ce68d2c6f44d?w=400" loading="lazy">
            </div>
            <div class="card-content">
              <div class="card-title">${job.title}</div>
              <div class="card-subtitle">${job.companyName || ''} â€¢ ${job.district || ''}</div>
              <div class="card-footer">
                <span><i class="fas fa-tag"></i> ${job.category || ''}</span>
                <span class="card-rating">
                  <strong>${KaziModules.Utils.formatCurrency(job.budget)}</strong>
                </span>
              </div>
            </div>
          </div>
        `;
      },

      renderMostUsed: function() {
        const grid = document.getElementById('mostUsedGrid');
        const freelancers = KaziModules.Data.getMostUsed();
        grid.innerHTML = freelancers.map(f => this.createFreelancerCard(f)).join('');
      },

      renderRecent: function() {
        const grid = document.getElementById('recentGrid');
        const freelancers = KaziModules.Data.getRecent();
        grid.innerHTML = freelancers.map(f => this.createFreelancerCard(f)).join('');
      },

      renderSuggested: function() {
        const grid = document.getElementById('suggestedGrid');
        const freelancers = KaziModules.Data.getSuggested();
        grid.innerHTML = freelancers.map(f => this.createFreelancerCard(f)).join('');
      },

      renderJobs: function() {
        const grid = document.getElementById('jobsGrid');
        grid.innerHTML = KaziModules.Data.allJobs.map(j => this.createJobCard(j)).join('');
      },

      renderCompanies: function() {
        const grid = document.getElementById('companiesGrid');
        grid.innerHTML = KaziModules.Data.allCompanies.map(c => this.createCompanyCard(c)).join('');
      },

      renderCategoryChips: function() {
        const chips = document.getElementById('categoryChips');
        chips.innerHTML = KaziModules.Data.allCategories.map(c => `
          <div class="category-chip" onclick="KaziModules.UI.loadCategory('${c}')">${c}</div>
        `).join('');
      },

      renderCategoryResults: function(category) {
        const grid = document.getElementById('categoryResults');
        const freelancers = KaziModules.Data.getCategoryFreelancers(category);
        grid.innerHTML = freelancers.map(f => this.createFreelancerCard(f)).join('');
      },

      renderSearchResults: function(results) {
        const container = document.getElementById('liveSearchResults');
        container.innerHTML = '';
        
        if (results.length === 0) {
          container.style.display = 'none';
          return;
        }
        
        results.forEach(r => {
          const div = document.createElement('div');
          div.className = 'search-result-item';
          div.onclick = () => {
            if (r.type === 'job') {
              window.location.href = `job.html?id=${r.id}`;
            } else {
              window.location.href = `profile.html?id=${r.id}`;
            }
          };
          
          if (r.type === 'freelancer') {
            div.innerHTML = `
              <img src="${r.data.profilePicture || 'https://images.unsplash.com/photo-1560250097-0b93528c311a?w=50'}" class="result-avatar">
              <div class="result-info">
                <div class="result-title">${r.data.fullName}</div>
                <div class="result-subtitle">${r.data.jobCategory || 'Freelancer'} â€¢ ${r.data.district || ''}</div>
              </div>
              <span class="result-badge">Freelancer</span>
            `;
          } else if (r.type === 'company') {
            div.innerHTML = `
              <img src="${r.data.logo || 'https://images.unsplash.com/photo-1556761175-b413da4baf72?w=50'}" class="result-avatar">
              <div class="result-info">
                <div class="result-title">${r.data.companyName}</div>
                <div class="result-subtitle">${r.data.district || ''}</div>
              </div>
              <span class="result-badge">Company</span>
            `;
          } else {
            div.innerHTML = `
              <div class="result-icon"><i class="fas fa-briefcase"></i></div>
              <div class="result-info">
                <div class="result-title">${r.data.title}</div>
                <div class="result-subtitle">${r.data.companyName || ''} â€¢ ${r.data.district || ''}</div>
              </div>
              <span class="result-badge">Job</span>
            `;
          }
          
          container.appendChild(div);
        });
        
        container.style.display = 'block';
      },

      renderCurrentTab: function() {
        if (KaziModules.UI.currentTab === 'freelancers') {
          this.renderMostUsed();
          this.renderRecent();
          this.renderSuggested();
        } else if (KaziModules.UI.currentTab === 'jobs') {
          this.renderJobs();
        } else if (KaziModules.UI.currentTab === 'companies') {
          this.renderCompanies();
        }
      }
    };

    // ==================== MODULE: UI ====================
    KaziModules.UI = {
      currentTab: 'freelancers',

      switchTab: function(tab) {
        this.currentTab = tab;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        event.target.classList.add('active');
        
        document.getElementById('freelancersSection').style.display = tab === 'freelancers' ? 'block' : 'none';
        document.getElementById('jobsSection').style.display = tab === 'jobs' ? 'block' : 'none';
        document.getElementById('companiesSection').style.display = tab === 'companies' ? 'block' : 'none';
        
        if (tab === 'jobs') KaziModules.Render.renderJobs();
        if (tab === 'companies') KaziModules.Render.renderCompanies();
      },

      loadMore: (type) => {
        KaziModules.showToast(`Loading more ${type}...`, 'info');
      },

      loadCategory: function(category) {
        document.querySelectorAll('.category-chip').forEach(chip => chip.classList.remove('active'));
        event.target.classList.add('active');
        KaziModules.Render.renderCategoryResults(category);
      },

      populateDropdowns: function() {
        const freelancerDistrict = document.getElementById('freelancerDistrict');
        if (freelancerDistrict) {
          freelancerDistrict.innerHTML = '<option value="">Select District</option>';
          KaziModules.Data.allDistricts.forEach(d => {
            freelancerDistrict.innerHTML += `<option value="${d}">${d}</option>`;
          });
        }
        
        const companyDistrict = document.getElementById('companyDistrict');
        if (companyDistrict) {
          companyDistrict.innerHTML = '<option value="">Select District</option>';
          KaziModules.Data.allDistricts.forEach(d => {
            companyDistrict.innerHTML += `<option value="${d}">${d}</option>`;
          });
        }
        
        const freelancerCategory = document.getElementById('freelancerCategory');
        if (freelancerCategory) {
          freelancerCategory.innerHTML = '<option value="">Select Category</option>';
          KaziModules.Data.allCategories.forEach(c => {
            freelancerCategory.innerHTML += `<option value="${c}">${c}</option>`;
          });
        }
      }
    };

    // ==================== MODULE: SEARCH ====================
    KaziModules.Search = {
      searchTimeout: null,

      performSearch: function() {
        const query = document.getElementById('searchInput').value;
        if (query.length < 2) {
          document.getElementById('liveSearchResults').style.display = 'none';
          return;
        }
        
        const results = KaziModules.Data.search(query);
        KaziModules.Render.renderSearchResults(results);
      },

      init: function() {
        document.getElementById('searchInput').addEventListener('input', () => {
          clearTimeout(this.searchTimeout);
          this.searchTimeout = setTimeout(() => this.performSearch(), 300);
        });

        document.addEventListener('click', (e) => {
          if (!e.target.closest('.search-container')) {
            document.getElementById('liveSearchResults').style.display = 'none';
          }
        });
      }
    };

    // ==================== MODULE: AUTH ====================
    KaziModules.Auth = {
      selectedRole: null,
      isLogin: false,
      loginRole: 'freelancer',

      toggleAuthMenu: function() {
        document.getElementById('authMenu').classList.toggle('show');
        document.getElementById('loginForm').classList.remove('show');
      },

      showLoginForm: function() {
        document.getElementById('authMenu').classList.remove('show');
        document.getElementById('loginForm').classList.add('show');
      },

      showSignupForm: function() {
        document.getElementById('loginForm').classList.remove('show');
        document.getElementById('authMenu').classList.add('show');
      },

      showAccountType: function(type) {
        document.getElementById('authMenu').classList.remove('show');
        if (type === 'freelancer') {
          document.getElementById('freelancerSignupModal').classList.remove('hidden');
        } else if (type === 'company') {
          document.getElementById('companySignupModal').classList.remove('hidden');
        } else {
          document.getElementById('userSignupModal').classList.remove('hidden');
        }
      },

      setLoginRole: function(role) {
        this.loginRole = role;
        document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
      },

      handleLogin: async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        try {
          await KaziModules.firebase.signInWithEmailAndPassword(KaziModules.auth, email, password);
          KaziModules.showToast('Login successful!', 'success');
          document.getElementById('loginForm').classList.remove('show');
          location.href = 'dashboard.html';
        } catch (error) {
          KaziModules.showToast(error.message, 'error');
        }
      },

      selectRole: function(role) {
        this.selectedRole = role;
        document.querySelectorAll('.account-card').forEach(c => c.classList.remove('selected'));
        document.getElementById(`role-${role}`).classList.add('selected');
        
        const form = document.getElementById('authForm');
        form.classList.remove('hidden');
        document.getElementById('authFormTitle').textContent = 
          `Create ${role.charAt(0).toUpperCase() + role.slice(1)} Account`;
        
        document.getElementById('uniqueNameGroup').style.display = role === 'user' ? 'block' : 'none';
      },

      handleAuth: async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const fullName = document.getElementById('fullName').value;
        const uniqueName = document.getElementById('uniqueName')?.value;
        
        if (!email || !password) {
          KaziModules.showToast('Please fill all fields', 'error');
          return;
        }
        
        try {
          if (this.isLogin) {
            await KaziModules.firebase.signInWithEmailAndPassword(KaziModules.auth, email, password);
            KaziModules.showToast('Logged in!', 'success');
            document.getElementById('authModal').classList.add('hidden');
            location.href = 'dashboard.html';
          } else {
            if (!this.selectedRole) {
              KaziModules.showToast('Please select account type', 'error');
              return;
            }
            
            if (this.selectedRole === 'user' && uniqueName) {
              const q = KaziModules.firebase.query(
                KaziModules.firebase.collection(KaziModules.db, 'users'), 
                KaziModules.firebase.where('uniqueName', '==', uniqueName)
              );
              const snap = await KaziModules.firebase.getDocs(q);
              if (!snap.empty) {
                KaziModules.showToast('Username taken', 'error');
                return;
              }
            }
            
            const userCred = await KaziModules.firebase.createUserWithEmailAndPassword(
              KaziModules.auth, 
              email, 
              password
            );
            
            const userData = {
              uid: userCred.user.uid,
              email,
              role: this.selectedRole,
              deviceId: this.selectedRole === 'user' ? KaziModules.deviceId : null,
              createdAt: new Date().toISOString(),
              verified: false,
              boosted: false,
              avgRating: 0,
              reviewCount: 0,
              followerCount: 0
            };
            
            if (this.selectedRole === 'freelancer') {
              userData.fullName = fullName;
              userData.status = 'Available';
              userData.portfolioImages = [];
            } else if (this.selectedRole === 'company') {
              userData.companyName = fullName;
              userData.images = [];
            } else {
              userData.uniqueName = uniqueName;
            }
            
            await KaziModules.firebase.setDoc(
              KaziModules.firebase.doc(KaziModules.db, 'users', userCred.user.uid), 
              userData
            );
            KaziModules.showToast('Account created!', 'success');
            document.getElementById('authModal').classList.add('hidden');
            location.href = 'dashboard.html';
          }
        } catch (error) {
          KaziModules.showToast(error.message, 'error');
        }
      },

      toggleAuthMode: function() {
        this.isLogin = !this.isLogin;
        document.getElementById('authSubmit').textContent = this.isLogin ? 'Sign In' : 'Create Account';
        document.getElementById('authFormTitle').textContent = this.isLogin ? 'Sign In' : 'Create Account';
        document.querySelector('.account-grid').style.display = this.isLogin ? 'none' : 'grid';
      }
    };

    // ==================== MODULE: REGISTRATION ====================
    KaziModules.Registration = {
      async uploadImage(file) {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('key', KaziModules.IMGBB_API_KEY);
        
        try {
          const response = await fetch(KaziModules.IMGBB_URL, { method: 'POST', body: formData });
          const data = await response.json();
          return data.success ? data.data.url : null;
        } catch (error) {
          console.error('Upload error:', error);
          return null;
        }
      },

      async registerFreelancer(e) {
        e.preventDefault();
        
        const file = document.getElementById('freelancerImage').files[0];
        let imageUrl = '';
        
        if (file) {
          KaziModules.showToast('Uploading image...', 'info');
          imageUrl = await this.uploadImage(file);
        }
        
        try {
          const userCred = await KaziModules.firebase.createUserWithEmailAndPassword(
            KaziModules.auth,
            document.getElementById('freelancerEmail').value,
            document.getElementById('freelancerPassword').value
          );
          
          const userData = {
            uid: userCred.user.uid,
            fullName: document.getElementById('freelancerName').value,
            profilePicture: imageUrl,
            phone: document.getElementById('freelancerPhone').value,
            email: document.getElementById('freelancerEmail').value,
            district: document.getElementById('freelancerDistrict').value,
            jobCategory: document.getElementById('freelancerCategory').value,
            role: 'freelancer',
            status: 'Available',
            verified: false,
            boosted: false,
            avgRating: 0,
            reviewCount: 0,
            followerCount: 0,
            views: 0,
            portfolioImages: [],
            createdAt: new Date().toISOString(),
            deviceId: KaziModules.deviceId
          };
          
          await KaziModules.firebase.setDoc(
            KaziModules.firebase.doc(KaziModules.db, 'users', userCred.user.uid), 
            userData
          );
          KaziModules.showToast('Registration successful!', 'success');
          document.getElementById('freelancerSignupModal').classList.add('hidden');
          location.href = 'dashboard.html';
        } catch (error) {
          KaziModules.showToast(error.message, 'error');
        }
      },

      async registerCompany(e) {
        e.preventDefault();
        
        const file = document.getElementById('companyLogo').files[0];
        let imageUrl = '';
        
        if (file) {
          KaziModules.showToast('Uploading logo...', 'info');
          imageUrl = await this.uploadImage(file);
        }
        
        try {
          const userCred = await KaziModules.firebase.createUserWithEmailAndPassword(
            KaziModules.auth,
            document.getElementById('companyEmail').value,
            document.getElementById('companyPassword').value
          );
          
          const userData = {
            uid: userCred.user.uid,
            companyName: document.getElementById('companyName').value,
            logo: imageUrl,
            phone: document.getElementById('companyPhone').value,
            email: document.getElementById('companyEmail').value,
            district: document.getElementById('companyDistrict').value,
            role: 'company',
            verified: false,
            boosted: false,
            avgRating: 0,
            reviewCount: 0,
            followerCount: 0,
            views: 0,
            images: [],
            jobs: [],
            createdAt: new Date().toISOString(),
            deviceId: KaziModules.deviceId
          };
          
          await KaziModules.firebase.setDoc(
            KaziModules.firebase.doc(KaziModules.db, 'users', userCred.user.uid), 
            userData
          );
          KaziModules.showToast('Registration successful!', 'success');
          document.getElementById('companySignupModal').classList.add('hidden');
          location.href = 'dashboard.html';
        } catch (error) {
          KaziModules.showToast(error.message, 'error');
        }
      },

      async registerUser(e) {
        e.preventDefault();
        
        const uniqueName = document.getElementById('userName').value;
        
        try {
          const q = KaziModules.firebase.query(
            KaziModules.firebase.collection(KaziModules.db, 'users'), 
            KaziModules.firebase.where('uniqueName', '==', uniqueName)
          );
          const snap = await KaziModules.firebase.getDocs(q);
          if (!snap.empty) {
            KaziModules.showToast('Username already taken', 'error');
            return;
          }
          
          const userCred = await KaziModules.firebase.createUserWithEmailAndPassword(
            KaziModules.auth,
            document.getElementById('userEmail').value,
            document.getElementById('userPassword').value
          );
          
          const userData = {
            uid: userCred.user.uid,
            uniqueName: uniqueName,
            email: document.getElementById('userEmail').value,
            role: 'user',
            deviceId: KaziModules.deviceId,
            createdAt: new Date().toISOString()
          };
          
          await KaziModules.firebase.setDoc(
            KaziModules.firebase.doc(KaziModules.db, 'users', userCred.user.uid), 
            userData
          );
          KaziModules.showToast('Registration successful!', 'success');
          document.getElementById('userSignupModal').classList.add('hidden');
          location.href = 'dashboard.html';
        } catch (error) {
          KaziModules.showToast(error.message, 'error');
        }
      }
    };

    // ==================== MODULE: APP INIT ====================
    KaziModules.App = {
      init: function() {
        console.log('ðŸš€ Kazi ni Kazi initializing...');
        
        // Initialize location
        KaziModules.Location.init();
        
        // Initialize search
        KaziModules.Search.init();
        
        // Set up auth state listener
        KaziModules.firebase.onAuthStateChanged(KaziModules.auth, (user) => {
          const authBtn = document.getElementById('authBtn');
          if (user) {
            authBtn.innerHTML = '<i class="fas fa-tachometer-alt"></i>';
            authBtn.onclick = () => location.href = 'dashboard.html';
          } else {
            authBtn.innerHTML = '<i class="fas fa-user"></i>';
            authBtn.onclick = KaziModules.Auth.toggleAuthMenu;
          }
        });
        
        // Close modals when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(modal => {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.classList.add('hidden');
            }
          });
        });
        
        // Load all data
        KaziModules.Data.loadAllData();
        
        console.log('âœ… Kazi ni Kazi ready!');
      }
    };
  </script>
</body>
</html>
